# LibreELEC USB/SD Creator 项目参考文档

## 1. 项目概述

**LibreELEC USB/SD Creator** 是一个轻量级、跨平台的图形界面应用程序，用于在 USB 驱动器和 SD 卡上创建 LibreELEC 安装介质。它提供了一个简单的四步向导界面，用于在 Windows、macOS 和 Linux 上下载并写入 LibreELEC 镜像到可移动存储设备。

### 核心信息

- **版本**: 1.5
- **许可证**: GNU General Public License v2+
- **代码仓库**: https://github.com/LibreELEC/usb-sd-creator
- **代码量**: 约 6,000 行代码，39 个源文件
- **支持语言**: 30+ 种语言翻译
- **支持平台**: Windows、macOS、Linux

### 主要功能

- 自动检测和显示可用的 LibreELEC 发布版本
- 多语言支持，自动检测系统语言（30+ 种语言）
- 跨平台兼容性（Windows、macOS、Linux）
- 镜像下载，支持断点续传和校验和验证
- 直接将镜像写入 USB/SD 卡，带进度跟踪
- 设备管理（弹出、加载、移除操作）
- 网络代理支持
- 拖放镜像文件支持

---

## 2. 项目结构

```
usb-sd-creator/
├── CMakeLists.txt              # 主构建配置（CMake）
├── CMakePresets.json           # 不同平台的构建预设
├── creator.pro                 # Qt 项目文件（传统 qmake 支持）
├── README.md                   # 构建和使用文档
├── LICENSE                     # GPL v2 许可证
│
├── 核心源文件
│   ├── main.cpp               # 应用程序入口点
│   ├── creator.cpp/h          # 主 UI 控制器和逻辑
│   ├── creator.ui             # Qt Designer UI 定义
│   ├── downloadmanager.cpp/h  # HTTP 下载管理
│   ├── diskwriter.cpp/h       # 磁盘写入基类接口
│   ├── deviceenumerator.h     # 设备枚举基类接口
│   ├── jsonparser.cpp/h       # JSON 解析（发布数据）
│   ├── translator.cpp/h       # 多语言支持
│   ├── movingaverage.cpp/h    # 速度计算工具
│   └── resources.qrc          # Qt 资源文件（图标、翻译）
│
├── 平台特定实现
│   ├── Windows
│   │   ├── diskwriter_windows.cpp/h
│   │   ├── deviceenumerator_windows.cpp/h
│   │   ├── privileges.h
│   │   ├── windows/winapp.rc.in
│   │   ├── windows/windows.manifest
│   │   ├── windows/winapp_le_icons.ico
│   │   └── windows/msvc*/zlib/          # MSVC 预编译 zlib
│   │
│   ├── macOS
│   │   ├── diskwriter_unix.cpp/h
│   │   ├── deviceenumerator_unix.cpp/h
│   │   ├── privileges_unix.cpp/h
│   │   ├── macos/askpass.cpp/h          # sudo 密码提示
│   │   ├── macos/codesign.sh            # 代码签名脚本
│   │   ├── macos/notarize.sh            # 公证脚本
│   │   ├── macos/Info.plist.in          # 应用程序包配置
│   │   └── macos/dmg_osx/               # DMG 安装程序资源
│   │
│   └── Linux
│       ├── diskwriter_udisks2.cpp/h     # UDisks2 D-Bus 接口
│       ├── deviceenumerator_udisks2.cpp/h
│       ├── diskwriter_unix.cpp/h        # 备用 Unix 实现
│       ├── deviceenumerator_unix.cpp/h
│       └── privileges_unix.cpp/h
│
├── UI 资源
│   ├── icons/                  # 应用程序图标和图形
│   │   ├── le_icon_256.png
│   │   ├── header.png
│   │   ├── no1.png - no4.png   # 步骤指示器
│   │   ├── device_*.png        # 设备操作图标
│   │   └── opencollective.png
│   │
│   ├── lang/                   # 翻译文件（30+ 种语言）
│   │   ├── lang-*.ts           # Qt 翻译源文件
│   │   └── flag-*.png          # 语言国旗图标
│   │
│   └── qss/                    # Qt 样式表
│       ├── stylesheet.qss      # 默认样式
│       └── stylesheet_osx.qss  # macOS 特定样式
│
├── 构建配置
│   ├── ci/
│   │   ├── linux/setup.sh      # Linux CI 设置
│   │   └── macos/setup.sh      # macOS CI 设置
│   │
│   ├── .github/
│   │   └── workflows/
│   │       └── build.yaml      # GitHub Actions CI/CD
│   │
│   └── linux_build.sh          # Linux 构建辅助脚本
│
└── 配置文件
    ├── .gitignore
    └── prepare_variables.bat   # Windows 构建辅助
```

---

## 3. 主要源文件详解

### 核心应用文件

#### **main.cpp** (146 行)
**功能**:
- 应用程序入口点
- 处理权限提升（macOS 使用带自定义 askpass 的 sudo）
- 处理命令行参数：
  - `--debug`: 启用调试模式
  - `--http-proxy`: 设置 HTTP 代理
  - `--no-proxy`: 禁用代理
  - `--elevated`: 标记已提升权限
- 设置网络代理配置
- 初始化 Creator 窗口

#### **creator.h/cpp** (5,583 行)
**功能**:
- 主应用程序控制器和 UI 逻辑
- 管理四步向导工作流：
  1. 选择 LibreELEC 项目/版本
  2. 下载镜像
  3. 选择目标设备
  4. 写入镜像到设备
- 状态机管理：
  - `IDLE`: 等待用户操作
  - `GET_VERSION`: 检查应用更新
  - `GET_RELEASES`: 下载发布列表
  - `DOWNLOADING_IMAGE`: 下载选定镜像
  - `WRITING_IMAGE`: 写入镜像到设备
- 处理下载进度、校验和验证、错误处理
- 实现拖放支持
- 管理设备枚举和刷新
- 处理语言切换和本地化
- 存储用户偏好（首选镜像、设备、语言）

**关键方法**:
- `parseAndSetVersion()`: 解析版本 JSON
- `parseAndSetReleases()`: 解析发布列表
- `downloadImage()`: 开始镜像下载
- `writeImageToDevice()`: 开始写入过程
- `refreshDeviceList()`: 刷新可用设备

#### **creator.ui** (26,918 字节)
**功能**:
- Qt Designer UI 定义
- 固定 490x490 像素对话框窗口
- 堆叠窗口部件，包含主页面和关于页面
- 四步指示器布局，带进度条
- 项目/版本/设备选择的组合框
- 下载和写入操作的进度条
- 下载、写入、弹出、加载、移除、帮助、关于按钮

### 下载管理

#### **downloadmanager.h/cpp** (2,034 行)
**功能**:
- 封装 Qt 的 QNetworkAccessManager
- 处理 HTTP GET 请求，支持重定向
- 支持部分下载（HTTP 206 响应）
- 发出进度、完成和错误信号
- 处理各种 HTTP 响应代码（200、206、302、307、400、404）
- 设置自定义 User-Agent 头（"Wget/1.14"）

**关键方法**:
- `get()`: 发起 HTTP GET 请求
- `handleRedirect()`: 处理 HTTP 重定向
- `downloadProgress()`: 报告下载进度
- `downloadFinished()`: 处理下载完成

### 磁盘写入

#### **diskwriter.h/cpp** (2,315 行)
**功能**:
- 平台特定磁盘写入的抽象基类
- 支持三种镜像格式：
  - 未压缩 (.img)
  - Gzip 压缩 (.gz)
  - Zip 压缩 (.zip)
- 使用 zlib 进行解压缩
- 发出进度（bytesWritten）、同步、完成和错误信号
- 可取消的写入操作

**关键方法**:
- `writeCompressedImageToRemovableDevice()`: 写入压缩镜像
- `writeUncompressedImageToRemovableDevice()`: 写入未压缩镜像
- `cancelWrite()`: 取消写入操作

**平台特定实现**:
- **diskwriter_windows.cpp/h**: 使用 Windows API（CreateFile、DeviceIoControl）直接访问磁盘
- **diskwriter_unix.cpp/h**: 使用 POSIX 文件操作（macOS）
- **diskwriter_udisks2.cpp/h**: 使用 D-Bus/UDisks2（Linux）

### 设备枚举

#### **deviceenumerator.h** (61 行)
**功能**:
- 设备检测和管理的抽象接口
- 关键方法：
  - `getRemovableDeviceNames()`: 列出可移动设备
  - `getUserFriendlyNames()`: 获取显示名称
  - `unmountDevicePartitions()`: 写入前卸载
  - `getSizeOfDevice()`: 获取设备容量
  - `loadEjectDrive()`: 弹出/加载操作
  - `removeDrive()`: 移除驱动器
  - `sizeToHuman()`: 格式化大小显示

**平台特定实现**:
- **deviceenumerator_windows.cpp/h**: 使用 Windows API（WMI、注册表）
- **deviceenumerator_unix.cpp/h**: 读取 /sys/block 和 /proc 获取设备信息（macOS）
- **deviceenumerator_udisks2.cpp/h**: 使用 D-Bus UDisks2 接口（Linux）

### 数据解析

#### **jsonparser.h/cpp** (2,145 行)
**功能**:
- 解析来自 LibreELEC 服务器的 JSON 发布数据
- 提取项目信息（名称、ID、URL）
- 提取镜像信息（文件名、大小、校验和）
- 按版本号排序镜像
- 支持多个项目和额外数据

**ProjectData 类**:
- 存储项目元数据
- 包含带校验和的可用镜像列表

**关键方法**:
- `parseProjectsAndImages()`: 解析 JSON 数据
- `getProjects()`: 获取项目列表
- `getImages()`: 获取特定项目的镜像

### 本地化

#### **translator.h/cpp** (1,602 行)
**功能**:
- 管理语言切换
- 加载 Qt 翻译文件 (.qm)
- 填充语言菜单，带国旗图标
- 持久化语言偏好
- 通过 Transifex 支持 30+ 种语言

**关键方法**:
- `fillLanguageBox()`: 填充语言选择框
- `changeLanguage()`: 切换应用语言
- `getLanguageSettingName()`: 获取保存的语言偏好

### 工具类

#### **movingaverage.h/cpp** (1,297 行)
**功能**:
- 计算下载速度的移动平均值
- 维护样本的滑动窗口
- 用于平滑速度显示

**关键方法**:
- `addValue()`: 添加新样本
- `average()`: 计算平均值

#### **privileges.h/cpp** (因平台而异)
**功能**:
- Windows: 存根实现（不需要权限管理）
- Unix/macOS: 管理特权操作的 UID/GID 切换
- 跟踪原始用户环境以访问 D-Bus

---

## 4. UI 组件说明

应用程序使用固定大小的对话框（490x490 像素），采用堆叠窗口部件布局：

### 主页面组件

1. **头部 Logo** - LibreELEC 品牌图像

2. **步骤 1 - 选择项目/版本**
   - 项目组合框
   - 版本组合框
   - "显示所有版本"复选框
   - 下载按钮

3. **步骤 2 - 下载进度**
   - 下载进度条，带文本覆盖
   - 显示已下载/总字节数和速度

4. **步骤 3 - 选择设备**
   - 设备组合框
   - 设备大小显示
   - 刷新按钮
   - 弹出/加载/移除按钮

5. **步骤 4 - 写入进度**
   - 写入进度条，带文本覆盖
   - 显示已写入/总字节数和速度

### 关于页面

- 应用程序信息
- 版本和构建日期
- 版权声明
- 帮助和 OpenCollective 链接

### 样式

- 自定义 Qt 样式表（QSS）实现跨平台一致性
- LibreELEC 蓝色（#00A9F6）用于进度条
- macOS 平台特定样式表

---

## 5. 后端/逻辑组件

### 状态机

- **STATE_IDLE**: 等待用户操作
- **STATE_GET_VERSION**: 检查应用更新
- **STATE_GET_RELEASES**: 下载发布列表
- **STATE_DOWNLOADING_IMAGE**: 下载选定镜像
- **STATE_WRITING_IMAGE**: 写入镜像到设备

### 下载工作流

1. 从 releases.libreelec.tv/creator_version 获取版本信息
2. 从 releases.libreelec.tv/ 获取发布 JSON
3. 解析 JSON 填充项目/版本列表
4. 下载选定镜像，支持断点续传
5. 验证 SHA256 校验和
6. 本地缓存镜像

### 写入工作流

1. 枚举可移动设备
2. 卸载设备分区
3. 打开设备进行写入
4. 如需要则解压缩镜像
5. 以 512KB 块写入
6. 同步文件系统
7. 关闭设备

### 错误处理

- 网络错误，支持重试
- 校验和不匹配检测
- 设备访问错误
- 磁盘空间不足检测
- 用户取消支持

---

## 6. 技术栈和依赖

### 核心框架

**Qt 6.7.2** (GUI、网络、线程、本地化)
- Qt Core
- Qt Gui
- Qt Network
- Qt Widgets
- Qt LinguistTools（翻译）
- Qt DBus（仅 Linux）

### 压缩

- **zlib** - 镜像解压缩

### 构建系统

- **CMake 3.19+** (主要)
- **Qt qmake** (传统支持)

### 平台特定

- **Windows**: Windows API、MSVC 2019/2022 或 MinGW
- **macOS**: Xcode、代码签名、公证
- **Linux**: GCC/G++、D-Bus、UDisks2

### CI/CD

- **GitHub Actions**
- 多平台构建（Ubuntu、macOS、Windows）

---

## 7. 构建和配置设置

### CMake 配置

- 支持多种生成器（Unix Makefiles、Ninja、NMake、Xcode）
- 平台特定源文件包含
- 自动 MOC、RCC、UIC 处理
- Qt 部署脚本生成
- CPack 用于安装程序创建

### 构建预设 (CMakePresets.json)

- `release`: Unix Makefiles
- `release-ninja`: Ninja 生成器
- `release-macos`: macOS 通用二进制（x86_64 + arm64）
- `release-msvc`: MSVC NMake Makefiles

### 打包

- **Windows**: Inno Setup 安装程序 (.exe) + ZIP 便携版
- **macOS**: DMG，带代码签名和公证
- **Linux**: Tarball，带二进制文件

### CI/CD 管道 (.github/workflows/build.yaml)

- 在 Ubuntu 22.04、macOS latest、Windows latest 上构建
- Windows 支持 MSVC 和 MinGW
- 自动上传构建产物
- macOS 代码签名和公证
- 通过 jurplel/install-qt-action 安装 Qt

---

## 8. 架构模式和设计决策

### 设计模式

1. **策略模式**: 平台特定实现（DiskWriter、DeviceEnumerator）
2. **观察者模式**: Qt 信号/槽事件处理
3. **状态机**: 应用工作流管理
4. **工厂模式**: main.cpp 中的平台特定对象创建

### 架构决策

1. **抽象基类**: 清晰分离平台特定代码
2. **线程**: 磁盘写入在独立 QThread 中运行，防止 UI 阻塞
3. **信号/槽架构**: 组件间解耦通信
4. **资源嵌入**: 图标和翻译编译到二进制文件中
5. **权限提升**: macOS 使用带自定义 askpass GUI 的 sudo；Windows 需要管理员清单
6. **网络代理**: 自动系统代理检测，支持手动覆盖
7. **校验和验证**: 写入前 SHA256 验证
8. **断点续传支持**: HTTP 范围请求用于部分下载
9. **本地化**: 通过 Transifex 支持 30+ 种语言，自动检测语言环境
10. **设置持久化**: QSettings 用于用户偏好（几何、语言、设备）

### 代码组织

- **平台抽象**: 条件编译（#ifdef Q_OS_*）最小化平台特定代码
- **模块化组件**: 每个主要功能在独立文件中
- **一致命名**: 平台后缀（_windows、_unix、_udisks2）
- **错误处理**: 全面的错误消息和用户反馈
- **性能**: 移动平均用于平滑速度显示，大文件分块 I/O

### 安全考虑

- 仅在必要时提升权限
- 校验和验证防止损坏的镜像
- 写入前卸载设备
- 破坏性操作需要用户确认
- 无硬编码凭据或敏感数据

---

## 9. 文件统计

- **总代码行数**: 约 6,038 行
- **源文件**: 39 个文件（.cpp、.h、.ui）
- **翻译文件**: 30+ 种语言文件（.ts）
- **图标资源**: 11 个 PNG 图像
- **样式表文件**: 2 个 QSS 文件
- **构建配置**: CMakeLists.txt、CMakePresets.json、creator.pro

---

## 10. 关键功能实现

### 多语言支持

- 30+ 种语言，带国旗图标
- 自动语言环境检测
- Transifex 集成用于社区翻译
- 语言偏好持久化

### 跨平台兼容性

- Windows/macOS/Linux 条件编译
- 平台特定设备枚举和写入
- 每个平台的原生外观和感觉
- 适合每个操作系统的权限提升

### 健壮的下载管理

- 通过 HTTP 范围请求支持断点续传
- 重定向跟踪（302、307）
- 校验和验证（SHA256）
- 进度跟踪和速度计算
- 网络代理支持

### 设备管理

- 自动检测可移动设备
- 设备大小显示
- 写入前分区卸载
- 弹出/加载/移除操作
- 设备刷新功能

### 用户体验

- 四步向导界面
- 拖放镜像支持
- 实时进度指示
- 全面的错误消息
- 帮助和关于对话框
- 窗口几何持久化

---

## 11. 构建说明

### Windows

```bash
# 使用 MSVC
cmake --preset release-msvc
cmake --build --preset release-msvc

# 使用 MinGW
cmake -G "MinGW Makefiles" -B build -DCMAKE_BUILD_TYPE=Release
cmake --build build
```

### macOS

```bash
cmake --preset release-macos
cmake --build --preset release-macos

# 代码签名和公证
cd build
../macos/codesign.sh
../macos/notarize.sh
```

### Linux

```bash
cmake --preset release
cmake --build --preset release

# 或使用辅助脚本
./linux_build.sh
```

---

## 12. 开发指南

### 添加新语言

1. 在 Transifex 上添加翻译
2. 下载 .ts 文件到 `lang/` 目录
3. 添加国旗图标到 `lang/flag-<locale>.png`
4. 在 `resources.qrc` 中添加条目
5. 重新构建应用程序

### 添加新平台支持

1. 创建 `diskwriter_<platform>.cpp/h`
2. 创建 `deviceenumerator_<platform>.cpp/h`
3. 在 `CMakeLists.txt` 中添加条件编译
4. 在 `main.cpp` 中实现平台检测
5. 测试所有功能

### 调试

```bash
# 启用调试输出
./creator --debug

# 设置代理
./creator --http-proxy http://proxy:8080

# 禁用代理
./creator --no-proxy
```

---

## 13. 常见问题

### Q: 如何添加新的 LibreELEC 项目？
A: 项目列表从 releases.libreelec.tv 自动获取，无需修改代码。

### Q: 支持哪些镜像格式？
A: .img（未压缩）、.gz（gzip）、.zip（zip）

### Q: 如何更改 UI 样式？
A: 编辑 `qss/stylesheet.qss` 或 `qss/stylesheet_osx.qss`

### Q: 如何添加新的设备类型？
A: 修改平台特定的 `deviceenumerator_*.cpp` 实现

### Q: 校验和验证失败怎么办？
A: 应用程序会自动重新下载镜像

---

## 14. 贡献指南

### 代码风格

- 遵循 Qt 编码约定
- 使用驼峰命名法
- 4 空格缩进
- 包含头文件保护

### 提交流程

1. Fork 仓库
2. 创建功能分支
3. 提交更改
4. 推送到分支
5. 创建 Pull Request

### 测试

- 在所有支持的平台上测试
- 验证 UI 在不同语言下正常工作
- 测试错误处理场景
- 验证设备检测和写入

---

## 15. 许可证

本项目采用 GNU General Public License v2 或更高版本许可。详见 LICENSE 文件。

---

## 16. 联系方式

- **项目主页**: https://libreelec.tv
- **GitHub**: https://github.com/LibreELEC/usb-sd-creator
- **论坛**: https://forum.libreelec.tv
- **捐赠**: https://opencollective.com/libreelec

---

**文档生成日期**: 2026-01-30
**文档版本**: 1.0
**对应项目版本**: 1.5
